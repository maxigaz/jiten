SHELL       := /bin/bash
BUILDOZER   ?= buildozer
PIP_INSTALL ?= pip install

export APP_VERSION := $(shell git describe | sed 's/^v//')
ifndef APP_VERSION
  $(error git describe failed)
endif

NUMERIC := $(shell python3 -c 'import sys,functools; print(10*functools.reduce(lambda x,y: x*100+int(y),([1]+sys.argv[1].replace("-",".").split(".")+[0])[:5],0))' $(APP_VERSION))
ifndef NUMERIC
  $(error numeric version command failed)
endif

.PHONY: debug clean

debug: debug-armeabi-v7a debug-arm64-v8a

clean:
	buildozer android clean
	rm -fr bin/

.PHONY: debug-armeabi-v7a debug-arm64-v8a
.PHONY: release-armeabi-v7a release-arm64-v8a

debug-armeabi-v7a:
	APP_ANDROID_ARCH=armeabi-v7a \
	APP_ANDROID_NUMERIC_VERSION=$$(( $(NUMERIC) + 1 )) \
	./scripts/buildozer.sh debug

debug-arm64-v8a:
	APP_ANDROID_NUMERIC_VERSION=$$(( $(NUMERIC) + 2 )) \
	./scripts/buildozer.sh debug

release-armeabi-v7a:
	APP_ANDROID_ARCH=armeabi-v7a \
	APP_ANDROID_NUMERIC_VERSION=$$(( $(NUMERIC) + 1 )) \
	./scripts/buildozer.sh release

release-arm64-v8a:
	APP_ANDROID_NUMERIC_VERSION=$$(( $(NUMERIC) + 2 )) \
	./scripts/buildozer.sh release

.PHONY: _setup_root _setup_user

_setup_root:
	apt-get install -y build-essential git
	apt-get install -y openjdk-11-jdk-headless
	apt-get install -y zlib1g-dev zip unzip pkg-config libffi-dev
	apt-get install -y libltdl-dev
	apt-get install -y lld

_setup_user:
	$(PIP_INSTALL) --upgrade $(BUILDOZER)
	$(PIP_INSTALL) --upgrade Cython==0.29.19 virtualenv
